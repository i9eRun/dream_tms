/*
 * File: app/view/tord/tord1002ViewController.js
 *
 * This file was generated by Sencha Architect version 4.3.7.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 7.9.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 7.9.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('dream.view.tord.tord1002ViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.tord.tord1002',

    onGridpanelAfterRender_order_grid: function(component, eOpts) {
        const store = component.getStore();
        const today = Ext.Date.format(new Date(), 'Y-m-d');

        // 1. proxyì˜ URLì„ ë™ì ìœ¼ë¡œ ì„¤ì •
        store.getProxy().setUrl(dream.util.Common.BASE_URL+'/tord/1002/order-list');

        // 2. í•„ìš” ì‹œ ì¶”ê°€ íŒŒë¼ë¯¸í„° ì„¤ì • (ì˜ˆ: userCetCd ë“±)
        store.getProxy().setExtraParams({
            userCetCd: dream.util.Common.LOGIN_USER_CET_CD,
            frDt: today,
            toDt: today
        });


    },

    onGridpanelSelectionChange_order_grid: function(model, selected, eOpts) {
        if (selected.length === 0) return;

        const form = this.lookupReference('order_form');
        let record = selected[0];

        if (form) {
            form.reset();

            //     if (record.get('ordDt')) {
            //         const str = record.get('ordDt');
            //         const date = Ext.Date.parse(str, 'Ymd');
            //         record.set('ordDt', date);
            //     }

            form.loadRecord(record);
        }
    },

    onTextfieldAfterRender_bigo_field: function(component, eOpts) {
        const grid = this.lookupReference('order_grid');
        const button = this.lookupReference('insert_button');

        component.on('specialkey', function(component, e) {
            if (e.getKey() === e.ENTER) {
                const selected = grid.getSelectionModel().getSelection();

                if (selected.length === 0) {
                    if (button) button.fireEvent('click', button);
                }
            }
        });
    },

    onComboboxAfterRender_ordChkGb: function(component, eOpts) {
        dream.util.Common.setComboCode(component,104,false);
    },

    onComboboxAfterRender_itemGb: function(component, eOpts) {
        dream.util.Common.setComboCode(component,208,false);
    },

    onComboboxAfterRender_chulgoGb: function(component, eOpts) {
        dream.util.Common.setComboCode(component,101,false);
    },

    onComboboxAfterRender_guljaeGb: function(component, eOpts) {
        dream.util.Common.setComboCode(component,102,false);
    },

    onComboboxAfterRender_singanGb: function(component, eOpts) {
        dream.util.Common.setComboCode(component,106,false);
    },

    onButtonClick_form_chulpan_search_button: function(button, e, eOpts) {
        const popup = Ext.create('dream.view.tpop.tpop1003');
        const form = this.lookupReference('order_form');
        const me = this;


        popup.on('selectUser', function(win, record) {
            const publisher_code_field = form.down('[name=chulpanCd]');
            const publisher_name_field = form.down('[name=chulpanNm]');
            publisher_code_field.setValue(record.get('CUST_CD'));
            publisher_name_field.setValue(record.get('CUST_NM'));
        });

        popup.show();
    },

    onButtonClick_form_sujum_search_button: function(button, e, eOpts) {
        const form = this.lookupReference('order_form');
        const chulpan_cd_value = form.down('[name=chulpanCd]').getValue();
        const chulpan_name_value = form.down('[name=chulpanNm]').getValue();

        if (!chulpan_cd_value) {
            Ext.Msg.alert('ì•Œë¦¼', 'ì¶œíŒì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const send_cd = chulpan_cd_value;
        const send_nm = chulpan_name_value;


        const popup = Ext.create('dream.view.tpop.tpop1006');
        const me = this;

        // ğŸ‘‰ íŒì—… ë‚´ë¶€ ê²€ìƒ‰ì–´ í•„ë“œì— ê°’ ì„¸íŒ… (ì˜ˆ: 'ê´€ì•…ì‚¬')
        popup.on('afterrender', function() {
            const searchField = popup.lookupReference('keyword');
            const popup_cd = popup.lookupReference('chulpan_code');
            const popup_nm = popup.lookupReference('chulpan_name');
            //     if (searchField) {
            //         searchField.setValue('ê´€ì•…ì‚¬');  // ì›í•˜ëŠ” ì´ˆê¸° ê²€ìƒ‰ì–´ ê°’
            //         // ìë™ ê²€ìƒ‰ ì‹¤í–‰ë„ ê°€ëŠ¥:
            //         // searchField.fireEvent('specialkey', searchField, { getKey: () => Ext.EventObject.ENTER });
            //     }

            if (popup_cd && popup_nm) {
                popup_cd.setValue(send_cd);
                popup_nm.setValue(send_nm);
            }
        });


        popup.on('selectUser', function(win, record) {
            const publisher_code_field = form.down('[name=sujumCd]');
            const publisher_name_field = form.down('[name=sujumNm]');
            publisher_code_field.setValue(record.get('custCd'));
            publisher_name_field.setValue(record.get('custAbbrNm'));
        });

        popup.show();
    },

    onFormAfterRender_order_form: function(component, eOpts) {
        const fields = ['chulpanNm', 'sujumNm', 'ordChkGb', 'itemGb', 'chulgoGb', 'guljaeGb', 'singanGb', 'bokQty', 'boxQty', 'ordAmt', 'bigo'];

        dream.util.Common.enableEnterKeyNavigation(component, fields);
    },

    onDatefieldAfterRender_start: function(component, eOpts) {
        const today = Ext.Date.format(new Date(), 'Y-m-d');
        component.setValue(today);

        const button = this.lookupReference('order_search_button');
        component.on('specialkey', function(component, e) {
            if (e.getKey() === e.ENTER) {
                if (button) {
                    button.fireEvent('click', button);
                }
            }
        });
    },

    onDatefieldAfterRender_end: function(component, eOpts) {
        const today = Ext.Date.format(new Date(), 'Y-m-d');
        component.setValue(today);

        const button = this.lookupReference('order_search_button');
        component.on('specialkey', function(component, e) {
            if (e.getKey() === e.ENTER) {
                if (button) {
                    button.fireEvent('click', button);
                }
            }
        });
    },

    onButtonClick_publisher_search_button: function(button, e, eOpts) {
        const popup = Ext.create('dream.view.tpop.tpop1003');
        const me = this;

        popup.on('selectUser', function(win, record) {
            const publisher_code_field = me.lookupReference('publisher_code');
            const publisher_name_field = me.lookupReference('publisher_name');
            publisher_code_field.setValue(record.get('CUST_CD'));
            publisher_name_field.setValue(record.get('CUST_NM'));
        });

        popup.show();
    },

    onButtonClick_bookstore_search_button: function(button, e, eOpts) {
        const popup = Ext.create('dream.view.tpop.tpop1003');
        const me = this;

        popup.on('selectUser', function(win, record) {
            const bookstore_code_field = me.lookupReference('bookstore_code');
            const bookstore_name_field = me.lookupReference('bookstore_name');
            bookstore_code_field.setValue(record.get('CUST_CD'));
            bookstore_name_field.setValue(record.get('CUST_NM'));
        });

        popup.show();
    },

    onButtonClick_order_search_button: function(button, e, eOpts) {
        const view = this.getView();
        const frDt = view.lookupReference('frDt').getValue();
        const toDt = view.lookupReference('toDt').getValue();
        const publisher = view.lookupReference('publisher_code').getValue();
        const bookstore = view.lookupReference('bookstore_code').getValue();
        const orderGrid = view.lookupReference('order_grid');
        const store = orderGrid.getStore();

        // ë‚ ì§œ í¬ë§· ì„¤ì • (yyyyMMdd ë˜ëŠ” yyyy-MM-dd ë“± ë°±ì—”ë“œì— ë§ê²Œ)
        const frDateStr = Ext.Date.format(frDt, 'Ymd');
        const toDateStr = Ext.Date.format(toDt, 'Ymd');

        store.getProxy().setExtraParams({
            userCetCd: dream.util.Common.LOGIN_USER_CET_CD,
            frDt: frDateStr,
            toDt: toDateStr,
            chulpanCd: publisher,
            sujumCd: bookstore
        });

        store.load();
    },

    onButtonClick_add_button: function(button, e, eOpts) {
        const form = this.lookupReference('order_form');

        // ì„ íƒëœ í–‰ ëª¨ë‘ í•´ì œ
        const grid = this.lookupReference('order_grid');
        const selectionModel = grid.getSelectionModel();
        selectionModel.deselectAll();



        if (form) {
            form.reset();
            let ordInputId = form.down('[name=ordInputId]');
            let ordChkGb = form.down('[name=ordChkGb]');
            let ordDt = form.down('[name=ordDt]');
            let ordRegiTime = form.down('[name=ordRegiTime]');

            //     const now = new Date();
            //     const timeOnly = Ext.Date.format(now, 'H:i:s');

            //     const timeField = form.down('[name=ordRegiTime]');
            //     if (timeField) {
            //         // ë¬¸ìì—´ â†’ Date ë³€í™˜ (ë‚ ì§œëŠ” ì˜ë¯¸ ì—†ê³  ì‹œê°„ë§Œ ì‚¬ìš©)
            //         const parsedTime = Ext.Date.parse(timeOnly, 'H:i:s');
            //         timeField.setValue(parsedTime);
            //     }

            const comboDefaults = ['itemGb', 'chulgoGb', 'guljaeGb', 'singanGb'];
            comboDefaults.forEach(name => {
                const field = form.down('[name=' + name + ']');
                if (field) {
                    field.setValue('01'); // ê¸°ë³¸ ì½”ë“œ ê°’ "01"ë¡œ ì„¤ì •
                }
            });

            ordChkGb.setValue('02');
            ordInputId.setValue(dream.util.Common.LOGIN_USER);
            ordDt.setValue(new Date());

            const now = new Date();
            ordRegiTime.setValue(new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0));

            const chulpanNmField = form.down('[name=chulpanNm]');
            if (chulpanNmField) {
                chulpanNmField.focus(true, 200); // 200ms ì§€ì—° í›„ í¬ì»¤ìŠ¤
            }

        }
    },

    onButtonClick_insert_button: function(button, e, eOpts) {
        const form = this.lookupReference('order_form');
        const store = this.lookupReference('order_grid').getStore();

        const order_no = form.down('[name=ordNo]').getValue();

        if (order_no) {
            Ext.Msg.alert('ì•Œë¦¼', 'ì¶”ê°€ë²„íŠ¼ í´ë¦­í›„ ë“±ë¡í•˜ì„¸ìš”.');
            return;
        }

        if (!form.isValid()) {
            Ext.Msg.alert('ì•Œë¦¼', 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        Ext.Msg.confirm('í™•ì¸', 'ì£¼ë¬¸ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function (btn) {
            if (btn !== 'yes') return;

            const values = form.getValues();
            values.userCetCd = dream.util.Common.LOGIN_USER_CET_CD;
            values.insertId = dream.util.Common.LOGIN_USER;

            // ë‚ ì§œ í•„ë“œ í¬ë§·: 'Ymd' í˜•íƒœë¡œ ë³€í™˜
            //     const dateFields = ['ordDt'];
            //     dateFields.forEach(key => {
            //         const field = form.down('[name=' + key + ']');
            //         if (field) {
            //             const val = field.getValue();
            //             if (val instanceof Date) {
            //                 values[key] = Ext.Date.format(val, 'Ymd'); // ì˜ˆ: 20250721
            //             }
            //         }
            //     });

            Ext.Ajax.request({
                url: dream.util.Common.BASE_URL + '/tord/1002/insert',
                method: 'POST',
                jsonData: values,
                success: function (response) {
                    Ext.Msg.alert('ì„±ê³µ', 'ì£¼ë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    form.reset();
                    store.reload();

                },
                failure: function (response) {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'ë“±ë¡ ì‹¤íŒ¨: ' + response.statusText);
                }
            });

        });





    },

    onButtonClick_update_button: function(button, e, eOpts) {
        const form = this.lookupReference('order_form');
        const store = this.lookupReference('order_grid').getStore();

        const ordNo = form.down('[name=ordNo]').getValue();

        if (!ordNo) {
            Ext.Msg.alert('ì•Œë¦¼', 'ìˆ˜ì •í•  ì£¼ë¬¸ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        if (!form.isValid()) {
            Ext.Msg.alert('ì•Œë¦¼', 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        Ext.Msg.confirm('í™•ì¸', 'ì£¼ë¬¸ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function (btn) {
            if (btn !== 'yes') return;

            const values = form.getValues();
            values.userCetCd = dream.util.Common.LOGIN_USER_CET_CD;
            values.updateId = dream.util.Common.LOGIN_USER;
            //values.updateDt = Ext.Date.format(new Date(), 'Y-m-d H:i:s');

            // ë‚ ì§œ í¬ë§· ë³€í™˜
            const convertDate = (name, format) => {
                const field = form.down('[name=' + name + ']');
                if (field && field.getValue()) {
                    values[name] = Ext.Date.format(field.getValue(), format);
                }
            };

            //convertDate('ordDt', 'Ymd');           // ì£¼ë¬¸ì¼ì
            //convertDate('labelPrtDt', 'Y-m-d');    // ë¼ë²¨ì¼ì
            //convertDate('ordRegiTime', 'H:i:s');   // ë“±ë¡ì‹œê°„

            Ext.Ajax.request({
                url: dream.util.Common.BASE_URL + '/tord/1002/update',
                method: 'PUT',
                jsonData: values,
                success: function (response) {
                    Ext.Msg.alert('ì„±ê³µ', 'ì£¼ë¬¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    form.reset();
                    store.reload();
                },
                failure: function (response) {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'ìˆ˜ì • ì‹¤íŒ¨: ' + response.statusText);
                }
            });
        });
    },

    onButtonClick_delete_button: function(button, e, eOpts) {
        const grid = this.lookupReference('order_grid');
        const selection = grid.getSelectionModel().getSelection();

        if (selection.length === 0) {
            Ext.Msg.alert('ì•Œë¦¼', 'ì‚­ì œí•  ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const record = selection[0];
        const ordNo = record.get('ordNo');
        const userCetCd = dream.util.Common.LOGIN_USER_CET_CD;

        Ext.Msg.confirm('í™•ì¸', 'ì„ íƒí•œ ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(btn) {
            if (btn !== 'yes') return;

            Ext.Ajax.request({
                url: dream.util.Common.BASE_URL + '/tord/1002/delete',
                method: 'DELETE',
                params: {
                    userCetCd: userCetCd,
                    ordNo: ordNo
                },
                success: function(response) {
                    Ext.Msg.alert('ì„±ê³µ', 'ì£¼ë¬¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    grid.getStore().reload();
                },
                failure: function(response) {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'ì‚­ì œ ì‹¤íŒ¨: ' + response.responseText);
                }
            });
        });
    },

    onPanelBeforeRender: function(component, eOpts) {
        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/101',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('101', codeList);
            }
        });
    }

});
