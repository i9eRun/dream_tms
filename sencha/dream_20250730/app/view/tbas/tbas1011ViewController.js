/*
 * File: app/view/tbas/tbas1011ViewController.js
 *
 * This file was generated by Sencha Architect version 4.3.7.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 7.9.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 7.9.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('dream.view.tbas.tbas1011ViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.tbas.tbas1011',

    onTextfieldAfterRender: function(component, eOpts) {
        const grid = this.lookupReference('list_grid');
        const store = grid.getStore();
        const view = this.getView(); // View ì ‘ê·¼

        component.on('specialkey', function(component, e) {
            if (e.getKey() === e.ENTER) {
                const editedValue = parseInt(component.getValue());

                if (isNaN(editedValue)) {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    return;
                }

                const selectionModel = grid.getSelectionModel();
                const record = selectionModel.getSelection()[0];

                if (!record) {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'í¸ì§‘ ëŒ€ìƒ ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const cusCd = record.get('cusCd');
                const oldValue = view.originalSunbun;

                // ë³€ê²½ ì—†ìœ¼ë©´ ë¬´ì‹œ
                if (oldValue === editedValue) return;

                // oldSubSunbun ë°±ì—…
                record.set('oldSubSunbun', oldValue);

                // 3. ìˆœë²ˆ ì¶©ëŒ ë°©ì§€ ì²˜ë¦¬
                store.each(function(rec) {
                    if (rec === record || rec.get('cusCd') !== cusCd) return;

                    const sunbun = parseInt(rec.get('subSunbun'));

                    if (editedValue < oldValue) {
                        // ì•ìœ¼ë¡œ ë‹¹ê¹€: ì¤‘ê°„ ìˆœë²ˆë“¤ +1
                        if (sunbun >= editedValue && sunbun < oldValue) {
                            rec.set('subSunbun', sunbun + 1);
                            rec.set('oldSubSunbun', sunbun);
                        }
                    } else {
                        // ë’¤ë¡œ ë°€ë¦¼: ì¤‘ê°„ ìˆœë²ˆë“¤ -1
                        if (sunbun <= editedValue && sunbun > oldValue) {
                            rec.set('subSunbun', sunbun - 1);
                            rec.set('oldSubSunbun', sunbun);
                        }
                    }
                });

                // 4. ìê¸° ìì‹  ìˆœë²ˆ ì„¤ì •
                record.set('subSunbun', editedValue);

                // 5. ì •ë ¬ ë° ì„ íƒ ìœ ì§€
                store.sort([{ property: 'subSunbun', direction: 'ASC' }]);

                Ext.defer(function() {
                    const idx = store.indexOf(record);
                    if (idx !== -1) {
                        grid.getSelectionModel().select(idx);
                    }
                }, 100);
            }
        }, this);








    },

    onGridpanelAfterRender_list_grid: function(component, eOpts) {
        const store = component.getStore();

        // 1. proxyì˜ URLì„ ë™ì ìœ¼ë¡œ ì„¤ì •
        store.getProxy().setUrl(dream.util.Common.BASE_URL+'/tbas/1011/list');

        // 2. í•„ìš” ì‹œ ì¶”ê°€ íŒŒë¼ë¯¸í„° ì„¤ì • (ì˜ˆ: userCetCd ë“±)
        store.getProxy().setExtraParams({
            userCetCd: dream.util.Common.LOGIN_USER_CET_CD
        });

    },

    onGridpanelCellClick: function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
        const column = tableview.getHeaderAtIndex(cellIndex);
        const columnDataIndex = column.dataIndex;

        if (columnDataIndex === 'subSunbun') {
            const originalValue = parseInt(record.get('subSunbun'));
            this.getView().originalSunbun = originalValue;
            console.log('originalSunbun ì €ì¥ë¨:', originalValue);
        }
    },

    onTextfieldAfterRender_search_cusCd: function(component, eOpts) {
        const button = this.lookupReference('search_button');
        component.on('specialkey', function(component, e) {
            if (e.getKey() === e.ENTER) {
                if (button) {
                    button.fireEvent('click', button);
                }
            }
        });
    },

    onTextfieldAfterRender_search_cusCd1: function(component, eOpts) {
        const button = this.lookupReference('sunbun_search_button');
        component.on('specialkey', function(component, e) {
            if (e.getKey() === e.ENTER) {
                if (button) {
                    button.fireEvent('click', button);
                }
            }
        });
    },

    onButtonClick_search_button: function(button, e, eOpts) {
        const popup = Ext.create('dream.view.tpop.tpop1005');
        const me = this;

        popup.on('selectUser', function(win, record) {
            const sch_cusCd = me.lookupReference('search_cusCd');

            sch_cusCd.setValue(record.get('cusCd'));

        });

        popup.show();
    },

    onButtonClick_reset_button: function(button, e, eOpts) {
        const grid = this.lookupReference('list_grid');
        const store = grid.getStore();

        store.rejectChanges();
        store.removeAll();
    },

    onButtonClick_load_button: function(button, e, eOpts) {
        const search_cusCd = this.lookupReference('search_cusCd').getValue();
        const store = this.lookupReference('list_grid').getStore();

        if (!search_cusCd) {
            Ext.Msg.alert('ì•Œë¦¼', 'ì½”ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
        }

        store.getProxy().setExtraParams({
            userCetCd: dream.util.Common.LOGIN_USER_CET_CD,
            cusCd: search_cusCd
        });

        store.load({
            callback: function (records) {
                records.forEach(record => {
                    record.set('oldSubSunbun', record.get('subSunbun'));
                });
            }
        });
    },

    onButtonClick_add_button: function(button, e, eOpts) {

        const grid = this.lookupReference('list_grid');
        const store = grid.getStore();
        const selection = grid.getSelection()[0];

        if (!selection) {
            Ext.Msg.alert('ì˜¤ë¥˜', 'í–‰ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const baseIndex = Number(selection.get('subSunbun')); // ê¸°ì¤€ ìˆœë²ˆ
        const cusCd = selection.get('cusCd'); // ë™ì¼ ê·¸ë£¹

        const popup = Ext.create('dream.view.tpop.tpop1003');
        const me = this;

        // âœ… íŒì—…ì—ì„œ ê±°ë˜ì²˜ ì„ íƒ ì‹œ ì´í›„ ë¡œì§ ì‹¤í–‰
        popup.on('selectUser', function(win, record) {
            console.log(record);
            const selectedCustCd = record.get('CUST_CD');
            const selectedCustGb = record.get('CUST_GB');
            const selectedCustNm = record.get('CUST_NM');
            const selectedjiyukNm = record.get('JIYUK_NM');

            if (!selectedCustCd) {
                Ext.Msg.alert('ì˜¤ë¥˜', 'ê±°ë˜ì²˜ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ğŸ‘‰ ìˆœë²ˆ ë°€ê¸°
            store.each(r => {
                if (r.get('cusCd') === cusCd && Number(r.get('subSunbun')) >= baseIndex) {
                    // ê¸°ì¡´ ìˆœë²ˆì„ ë°±ì—… (í•œ ë²ˆë§Œ ì €ì¥)
                    //             if (!r.get('oldSubSunbun')) {
                    //                 r.set('oldSubSunbun', r.get('subSunbun'));
                    //             }
                    r.set('subSunbun', Number(r.get('subSunbun')) + 1);
                }
            });

            // ğŸ‘‰ ìƒˆ ë ˆì½”ë“œ ìƒì„±
            const newRecord = store.model.create({
                userCetCd: dream.util.Common.LOGIN_USER_CET_CD,
                cusCd: cusCd,
                subSunbun: baseIndex,
                custCd: selectedCustCd,
                custGb: selectedCustGb,
                custNm: selectedCustNm,
                jiyukNm: selectedjiyukNm,
                subWorkGb: '1',
                subOrderGb: '01',
                subChulGb: '',
                insertId: dream.util.Common.LOGIN_USER,
                updateId: dream.util.Common.LOGIN_USER
            });

            // ğŸ‘‰ ì¶”ê°€ ë° ì •ë ¬
            store.add(newRecord);
            store.sort('subSunbun', 'ASC');

            // ğŸ‘‰ ì„ íƒ ìœ ì§€
            Ext.defer(() => {
                const matched = store.findRecord('subSunbun', baseIndex, 0, false, true);
                if (matched) {
                    grid.getSelectionModel().select(matched);
                }
            }, 50);
        });

        popup.show();

    },

    onButtonClick_delete_button: function(button, e, eOpts) {
        const grid = this.lookupReference('list_grid');
        const store = grid.getStore();
        const selection = grid.getSelectionModel().getSelection()[0];

        if (!selection) {
            Ext.Msg.alert('ì˜¤ë¥˜', 'ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        // ê¸°ì¤€ ê°’ ì¶”ì¶œ
        const deletedSunbun = Number(selection.get('subSunbun'));
        const deletedCusCd = selection.get('cusCd');

        // 1. ì‚­ì œ ëŒ€ìƒ ë¡œìš° ì œê±°
        store.remove(selection);

        // 2. ì‚­ì œëœ ìˆœë²ˆ ì´í›„ í•­ëª©ë“¤ì˜ ìˆœë²ˆì„ -1ë¡œ ì¡°ì •
        store.each(record => {
            const currentSunbun = Number(record.get('subSunbun'));
            if (record.get('cusCd') === deletedCusCd && currentSunbun > deletedSunbun) {
                record.set('subSunbun', currentSunbun - 1);
            }
        });

        // 3. ì •ë ¬
        store.sort('subSunbun', 'ASC');

        // 4. ë‹¤ìŒ í•­ëª© ìë™ ì„ íƒ
        Ext.defer(() => {
            const nextRecord = store.findRecord('subSunbun', deletedSunbun, 0, false, true);
            if (nextRecord) {
                grid.getSelectionModel().select(nextRecord);
            } else if (store.getCount() > 0) {
                // ë‹¤ìŒ í•­ëª©ì´ ì—†ë‹¤ë©´ ë§ˆì§€ë§‰ í•­ëª© ì„ íƒ
                grid.getSelectionModel().select(store.getCount() - 1);
            }
        }, 50);
    },

    onButtonClick_save_button: function(button, e, eOpts) {
        const grid = this.lookupReference('list_grid');
        const store = grid.getStore();

        // ì‹ ê·œ ë°ì´í„°
        const newRecords = store.getNewRecords().map(r => {
            const data = r.getData();
            return data;
        });

        // ìˆ˜ì •ëœ ë°ì´í„°: oldSubSunbun ê³ ë ¤
        const updatedRecords = store.getUpdatedRecords().map(r => {
            const data = r.getData();
            // oldSubSunbunì´ ì—†ìœ¼ë©´ ì›ë˜ subSunbunì„ ë³µì‚¬í•´ì¤Œ
            //     if (!data.oldSubSunbun) {
            //         data.oldSubSunbun = data.subSunbun;
            //     }
            return data;
        });

        // ì‚­ì œëœ ë°ì´í„°
        const removedRecords = store.getRemovedRecords().map(r => r.getData());

        const payload = {
            insertList: newRecords,
            updateList: updatedRecords,
            deleteList: removedRecords
        };

        Ext.Msg.confirm('í™•ì¸', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(btn) {
            if (btn !== 'yes') return;

            Ext.Ajax.request({
                url: dream.util.Common.BASE_URL + '/tbas/1011/save',
                method: 'POST',
                jsonData: payload,
                success: function(response) {
                    const res = Ext.decode(response.responseText);
                    if (res.success) {
                        Ext.Msg.alert('ì•Œë¦¼', 'ì €ì¥ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        store.reload();
                    } else {
                        Ext.Msg.alert('ì‹¤íŒ¨', res.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                },
                failure: function(response) {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'ì„œë²„ í†µì‹  ì˜¤ë¥˜ ë˜ëŠ” ì €ì¥ ì‹¤íŒ¨');
                }
            });
        });
    },

    onButtonClick_sunbun_search_button: function(button, e, eOpts) {
        let searchMatches = [];
        let searchIndex = 0;


        const grid = this.lookupReference('list_grid');
        const store = grid.getStore();
        const keyword = this.lookupReference('search_cusNm').getValue();

        if (!keyword) {
            Ext.Msg.alert('ì•Œë¦¼', 'ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        // ì²« ê²€ìƒ‰ì´ê±°ë‚˜ í‚¤ì›Œë“œê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ ì¼ì¹˜ í•­ëª©ì„ ë‹¤ì‹œ ì°¾ìŒ
        if (!this.lastKeyword || this.lastKeyword !== keyword) {
            this.searchMatches = [];

            store.each((record, index) => {
                const name = record.get('custNm') || '';
                if (name.includes(keyword)) {
                    this.searchMatches.push(index);
                }
            });

            this.searchIndex = 0;
            this.lastKeyword = keyword;
        }

        if (this.searchMatches.length === 0) {
            Ext.Msg.alert('ê²°ê³¼ ì—†ìŒ', `'${keyword}'ì´(ê°€) í¬í•¨ëœ ê±°ë˜ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        // í˜„ì¬ ì¸ë±ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ë ˆì½”ë“œ ì„ íƒ ë° í¬ì»¤ìŠ¤
        const matchedIndex = this.searchMatches[this.searchIndex];
        const record = store.getAt(matchedIndex);

        const rowIndex = matchedIndex;
        const columnIndex = grid.getColumnManager().getHeaderIndex('subSunbun');

        grid.getSelectionModel().select(record); // í–‰ ì„ íƒ

        grid.getView().focusCell({
            row: rowIndex,
            column: columnIndex
        });

        // ë‹¤ìŒ ê²€ìƒ‰ ìœ„ì¹˜ë¡œ ì´ë™ (ìˆœí™˜)
        this.searchIndex = (this.searchIndex + 1) % this.searchMatches.length;
    },

    onPanelBeforeRender: function(component, eOpts) {
        dream.util.Common.loadCode('168');
        dream.util.Common.loadCode('1003');
        dream.util.Common.loadCode('1022');

    }

});
