/*
 * File: app/view/treo/treo1001ViewController.js
 *
 * This file was generated by Sencha Architect version 4.3.7.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 7.9.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 7.9.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('dream.view.treo.treo1001ViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.treo.treo1001',

    onComboboxAfterRender_chkGb: function(component, eOpts) {
        dream.util.Common.setComboCode(component,116,false);
    },

    onComboboxAfterRender_reordFaultGb: function(component, eOpts) {
        dream.util.Common.setComboCode(component,298,false);
    },

    onComboboxAfterRender_reordReasonGb: function(component, eOpts) {
        dream.util.Common.setComboCode(component,259,false);
    },

    onComboboxAfterRender_reordGb: function(component, eOpts) {
        dream.util.Common.setFlagCombo(component,"ì •ë°˜","","");
    },

    onButtonClick_form_chulpan: function(button, e, eOpts) {
        const popup = Ext.create('dream.view.tpop.tpop1003');
        const me = this;


        popup.on('selectUser', function(win, record) {
            const form = me.lookupReference('detail_form');

            const code_field = form.down('[name=chulpanCd]');
            const name_field = form.down('[name=chulpanNm]');

            code_field.setValue(record.get('CUST_CD'));
            name_field.setValue(record.get('CUST_NM'));
        });

        popup.show();
    },

    onButtonClick_form_sujum: function(button, e, eOpts) {
        const form = this.lookupReference('detail_form');
        const chulpan_cd_value = form.down('[name=chulpanCd]').getValue();
        const chulpan_name_value = form.down('[name=chulpanNm]').getValue();

        if (!chulpan_cd_value) {
            Ext.Msg.alert('ì•Œë¦¼', 'ì¶œíŒì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const send_cd = chulpan_cd_value;
        const send_nm = chulpan_name_value;


        const popup = Ext.create('dream.view.tpop.tpop1006');
        const me = this;

        // ğŸ‘‰ íŒì—… ë‚´ë¶€ ê²€ìƒ‰ì–´ í•„ë“œì— ê°’ ì„¸íŒ… (ì˜ˆ: 'ê´€ì•…ì‚¬')
        popup.on('afterrender', function() {
            const searchField = popup.lookupReference('keyword');
            const popup_cd = popup.lookupReference('chulpan_code');
            const popup_nm = popup.lookupReference('chulpan_name');

            if (popup_cd && popup_nm) {
                popup_cd.setValue(send_cd);
                popup_nm.setValue(send_nm);
            }
        });


        popup.on('selectUser', function(win, record) {
            const publisher_code_field = form.down('[name=sujumCd]');
            const publisher_name_field = form.down('[name=sujumNm]');
            publisher_code_field.setValue(record.get('custCd'));
            publisher_name_field.setValue(record.get('custAbbrNm'));
        });

        popup.show();







    },

    onGridpanelAfterRender_list_grid: function(component, eOpts) {
        const store = component.getStore();

        // 1. proxyì˜ URLì„ ë™ì ìœ¼ë¡œ ì„¤ì •
        store.getProxy().setUrl(dream.util.Common.BASE_URL+'/treo/1001/list');

        // 2. í•„ìš” ì‹œ ì¶”ê°€ íŒŒë¼ë¯¸í„° ì„¤ì • (ì˜ˆ: userCetCd ë“±)
        store.getProxy().setExtraParams({
            userCetCd: dream.util.Common.LOGIN_USER_CET_CD
        });


    },

    onGridpanelSelectionChange_list_grid: function(model, selected, eOpts) {
        if (selected.length === 0) return;

        const form = this.lookupReference('detail_form');

        if (form) {
            form.reset();
            form.loadRecord(selected[0]);
        }
    },

    onDatefieldAfterRender_start_date: function(component, eOpts) {
        const view = this.getView();
        component.setValue(new Date());
        component.on('specialkey', function(component, e) {
            if (e.getKey() === e.ENTER) {
                const button = view.lookupReference('search_button');
                if (button) {
                    button.fireEvent('click', button);
                }
            }
        });
    },

    onDatefieldAfterRender_end_date: function(component, eOpts) {
        const view = this.getView();
        component.setValue(new Date());
        component.on('specialkey', function(component, e) {
            if (e.getKey() === e.ENTER) {
                const button = view.lookupReference('search_button');
                if (button) {
                    button.fireEvent('click', button);
                }
            }
        });
    },

    onButtonClick_search_button: function(button, e, eOpts) {
        const start_date = this.lookupReference('start_date').getSubmitValue();
        const end_date = this.lookupReference('end_date').getSubmitValue();
        const chulpan_code = this.lookupReference('chulpan_code').getValue();
        const sujum_code = this.lookupReference('sujum_code').getValue();
        const store = this.lookupReference('list_grid').getStore();

        store.getProxy().setExtraParams({
            userCetCd: dream.util.Common.LOGIN_USER_CET_CD,
            startDate: start_date,
            endDate: end_date,
            chulpanCd: chulpan_code,
            sujumCd: sujum_code
        });

        store.load();
    },

    onButtonClick_add_button: function(button, e, eOpts) {
        const form = this.lookupReference('detail_form');
        const grid = this.lookupReference('list_grid');
        const selModel = grid.getSelectionModel();
        selModel.deselectAll();
        form.reset();

        const date_field = form.down('[name=reordDt]');
        date_field.setReadOnly(true);
        date_field.setValue(new Date());
        form.down('[name=insertId]').setValue(dream.util.Common.LOGIN_USER);
        form.down('[name=chulpanNm]').focus(true,200);

    },

    onButtonClick_insert_button: function(button, e, eOpts) {
        const form = this.lookupReference('detail_form');
        const store = this.lookupReference('list_grid').getStore();

        const reordNoField = form.down('[name=reordNo]');
        if (reordNoField.getValue()) {
            Ext.Msg.alert('ì•Œë¦¼', 'ì´ë¯¸ ë“±ë¡ëœ ì‚¬ê³ ì…ë‹ˆë‹¤.');
            return;
        }

        if (!form.isValid()) {
            Ext.Msg.alert('ì•Œë¦¼', 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        Ext.Msg.confirm('í™•ì¸', 'ì‚¬ê³  ì •ë³´ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(choice) {
            if (choice !== 'yes') return;

            const values = form.getValues();
            values.insertId = dream.util.Common.LOGIN_USER;
            values.userCetCd = dream.util.Common.LOGIN_USER_CET_CD;

            Ext.Ajax.request({
                url: dream.util.Common.BASE_URL + '/treo/1001/insert',
                method: 'POST',
                jsonData: values,
                success: function(response) {
                    const result = Ext.decode(response.responseText);
                    if (result.success) {
                        Ext.Msg.alert('ì„±ê³µ', 'ì‚¬ê³ ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');

                        // ë“±ë¡ëœ ì‚¬ê³ ë²ˆí˜¸ë¡œ í•„ë“œ ì—…ë°ì´íŠ¸
                        if (result.data && result.data.reordNo) {
                            reordNoField.setValue(result.data.reordNo);
                        }

                        store.reload(); // ëª©ë¡ ê°±ì‹ 
                    } else {
                        Ext.Msg.alert('ì‹¤íŒ¨', result.message || 'ë“±ë¡ ì‹¤íŒ¨');
                    }
                },
                failure: function(response) {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });
    },

    onButtonClick_update_button: function(button, e, eOpts) {
        const form = this.lookupReference('detail_form');
        const store = this.lookupReference('list_grid').getStore();
        const reordNoField = form.down('[name=reordNo]');

        if (!reordNoField || !reordNoField.getValue()) {
            Ext.Msg.alert('ì•Œë¦¼', 'ìˆ˜ì •í•  ì‚¬ê³ ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        if (!form.isValid()) {
            Ext.Msg.alert('ì•Œë¦¼', 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        Ext.Msg.confirm('í™•ì¸', 'ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function (btn) {
            if (btn !== 'yes') return;

            const values = form.getValues();
            values.updateId = dream.util.Common.LOGIN_USER;
            values.userCetCd = dream.util.Common.LOGIN_USER_CET_CD;

            Ext.Ajax.request({
                url: dream.util.Common.BASE_URL + '/treo/1001/update',
                method: 'PUT',
                jsonData: values,
                success: function (response) {
                    const result = Ext.decode(response.responseText);
                    if (result.success) {
                        Ext.Msg.alert('ì„±ê³µ', 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        store.reload();
                    } else {
                        Ext.Msg.alert('ì‹¤íŒ¨', result.message || 'ìˆ˜ì • ì‹¤íŒ¨');
                    }
                },
                failure: function () {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });
    },

    onButtonClick_delete_button: function(button, e, eOpts) {
        const form = this.lookupReference('detail_form');
        const store = this.lookupReference('list_grid').getStore();

        const reordNo = form.down('[name=reordNo]').getValue();
        const userCetCd = dream.util.Common.LOGIN_USER_CET_CD;

        if (!reordNo) {
            Ext.Msg.alert('ì•Œë¦¼', 'ì‚­ì œí•  ì‚¬ê³ ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        Ext.Msg.confirm('í™•ì¸', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function (btn) {
            if (btn !== 'yes') return;

            Ext.Ajax.request({
                url: dream.util.Common.BASE_URL + '/treo/1001/delete',
                method: 'DELETE',
                jsonData: {
                    reordNo: reordNo,
                    userCetCd: userCetCd
                },
                success: function (response) {
                    const result = Ext.decode(response.responseText);
                    if (result.success) {
                        Ext.Msg.alert('ì„±ê³µ', 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        store.reload();
                        form.reset(); // í¼ ì´ˆê¸°í™”
                    } else {
                        Ext.Msg.alert('ì‹¤íŒ¨', result.message || 'ì‚­ì œ ì‹¤íŒ¨');
                    }
                },
                failure: function () {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });
    },

    onButtonClick_chulpan_search_button: function(button, e, eOpts) {
        const popup = Ext.create('dream.view.tpop.tpop1003');
        const me = this;

        popup.on('selectUser', function(win, record) {
            const code_field = me.lookupReference('chulpan_code');
            const name_field = me.lookupReference('chulpan_name');

            code_field.setValue(record.get('CUST_CD'));
            name_field.setValue(record.get('CUST_NM'));
        });

        popup.show();

    },

    onButtonClick_sujum_search_button: function(button, e, eOpts) {
        const popup = Ext.create('dream.view.tpop.tpop1003', {
            listeners: {
                show: function(win) {
                    const combo = win.down('#tpop1003_cust_gb');
                    const store = combo.getStore();

                    if (store.isLoaded()) {
                        combo.setValue('2');
                    } else {
                        store.load({
                            callback: function() {
                                combo.setValue('2');
                            }
                        });
                    }
                }
            }

        }).show();


        const me = this;

        popup.on('selectUser', function(win, record) {
            console.log(record);

            const code_field = me.lookupReference('sujum_code');
            const name_field = me.lookupReference('sujum_name');

            code_field.setValue(record.get('CUST_CD'));
            name_field.setValue(record.get('CUST_NM'));
        });

        popup.show();

    },

    onPanelBeforeRender: function(component, eOpts) {
        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/116',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('116', codeList);
            }
        });

        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/298',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('298', codeList);
            }
        });

        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/259',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('259', codeList);
            }
        });






    },

    onPanelAfterRender: function(component, eOpts) {
        const form = this.lookupReference('detail_form');
        form.reset();
    }

});
