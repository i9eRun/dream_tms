/*
 * File: app/view/tsys/tsys1001ViewController.js
 *
 * This file was generated by Sencha Architect version 4.3.7.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 7.9.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 7.9.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('dream.view.tsys.tsys1001ViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.tsys.tsys1001',

    onTsys1001_user_searchAfterRender: function(component, eOpts) {
        component.on('specialkey', function(component, e) {
            if (e.getKey() === e.ENTER) {
                const button = Ext.getCmp('tsys_btn_user_search');
                if (button) {
                    button.fireEvent('click', button);
                }
            }
        });
    },

    onCbo_user_chk_gb_schAfterRender: function(component, eOpts) {
        dream.util.Common.setComboCode(component,257);
    },

    onCbo_use_yn_schAfterRender: function(component, eOpts) {
        dream.util.Common.setFlagCombo(component,"ì‚¬ìš©","ì „ì²´","");
    },

    onCbo_geunmoo_jo_schAfterRender: function(component, eOpts) {
        dream.util.Common.setComboCode(component,151);
    },

    onTsys_btn_user_searchClick: function(button, e, eOpts) {
        const view = this.getView();
        const grid = view.lookupReference('tsys1001_user_grid');
        const store = grid.getStore();

        const search_keyword = Ext.getCmp('tsys1001_user_search').getValue();
        const user_chk_gb = Ext.getCmp('cbo_user_chk_gb_sch').getValue();
        const cbo_use_yn_sch = Ext.getCmp('cbo_use_yn_sch').getValue();
        const cbo_geunmoo_jo_sch = Ext.getCmp('cbo_geunmoo_jo_sch').getValue();



        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL+'/tsys/user',
            method: 'GET',
            params:{
                search_keyword : search_keyword,
                user_chk_gb : user_chk_gb,
                cbo_use_yn_sch : cbo_use_yn_sch,
                cbo_geunmoo_jo_sch : cbo_geunmoo_jo_sch

            },
            success: function(response) {
                const json = Ext.decode(response.responseText);
                store.setData(json);
            },
            failure: function(response) {
                Ext.Msg.alert('ì—ëŸ¬', 'ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    },

    onTsys1001UserGridAfterRender: function(component, eOpts) {
        const store = component.getStore();
        store.getProxy().setUrl(dream.util.Common.BASE_URL+'/tsys/user');

        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL+'/tsys/user',
            method: 'GET',
            success: function(response) {
                const json = Ext.decode(response.responseText);
                store.setData(json);
            },
            failure: function(response) {
                Ext.Msg.alert('ì—ëŸ¬', 'ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    },

    onGridpanelSelectionChange_tsys1001_user_grid: function(model, selected, eOpts) {
        if (!selected || selected.length === 0) {
            console.warn('ì„ íƒëœ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        console.log(selected[0].data);
        const form = this.lookupReference('tsys1001_user_form');
        const userIdField = form.down('[name=userId]');
        let record = selected[0];

        if (record.get('enterDt') !== null) record.set('enterDt', new Date(record.get('enterDt')));
        if (record.get('retireDt') !== null) record.set('retireDt', new Date(record.get('retireDt')));
        if (record.get('jikchkDt') !== null) record.set('jikchkDt', new Date(record.get('jikchkDt')));
        if (record.get('pdaBanDt') !== null) record.set('pdaBanDt', new Date(record.get('pdaBanDt')));
        if (record.get('pdaBulDt') !== null) record.set('pdaBulDt', new Date(record.get('pdaBulDt')));
        if (record.get('sumUniformBanDt') !== null) record.set('sumUniformBanDt', new Date(record.get('sumUniformBanDt')));
        if (record.get('sumUniformBulDt') !== null) record.set('sumUniformBulDt', new Date(record.get('sumUniformBulDt')));
        if (record.get('winUniformBanDt') !== null) record.set('winUniformBanDt', new Date(record.get('winUniformBanDt')));
        if (record.get('winUniformBulDt') !== null) record.set('winUniformBulDt', new Date(record.get('winUniformBulDt')));

        if (form) {
            form.reset();
            form.loadRecord(selected[0]);  // ë ˆì½”ë“œë¥¼ í¼ì— ë¡œë”©
            userIdField.setReadOnly(true);
        }
    },

    onJIKWEE_CDAfterRender: function(component, eOpts) {
        dream.util.Common.setComboCode(component,240,false);
    },

    onJIKCHK_CDAfterRender: function(component, eOpts) {
        dream.util.Common.setComboCode(component,241,false);
    },

    onUSE_YNAfterRender: function(component, eOpts) {
        dream.util.Common.setFlagCombo(component,"ì‚¬ìš©","","1");
    },

    onUSER_AUTH_ADMAfterRender: function(component, eOpts) {
        dream.util.Common.setComboCode(component,373,false);
    },

    onUSER_AUTH_RWAfterRender: function(component, eOpts) {
        dream.util.Common.setFlagCombo(component,"ì˜ˆì•„ë‹ˆìš”","","0");
    },

    onGEUNMOO_JOAfterRender: function(component, eOpts) {
        dream.util.Common.setComboCode(component,151,false);
    },

    onFORM_USER_CHK_GBAfterRender: function(component, eOpts) {
        dream.util.Common.setComboCode(component,257,false);

    },

    onJAEJIK_GBAfterRender: function(component, eOpts) {
        dream.util.Common.setComboCode(component,242,false);

    },

    onTsys1001_new_userClick: function(button, e, eOpts) {
        const form = this.lookupReference('tsys1001_user_form');

        form.reset();

        const userIdField = form.down('[name=userId]');
        if (userIdField) {
            // ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
            userIdField.setReadOnly(false);

            // í¬ì»¤ìŠ¤ ì£¼ê¸°
            userIdField.focus(false, 100);

            // ë¹¨ê°„ í…Œë‘ë¦¬ ì ìš© ë“± í•„ìš” ì‹œ ì¶”ê°€
            // userIdField.setFieldStyle('border: 1px solid red;');
        }
    },

    onTsys1001_user_insertClick: function(button, e, eOpts) {
        // const view = this.getView();
        // const store = view.lookupReference('tsys1001_user_grid').getStore();
        // const form = view.lookupReference('tsys1001_user_form');
        // const values = form.getValues();
        // values.userCetCd = dream.util.Common.LOGIN_USER_CET_CD;

        // Ext.Ajax.request({
        //     url: dream.util.Common.BASE_URL + '/tsys/user/insert',
        //     method: 'POST',
        //     jsonData: values,
        //     success: function() {
        //         Ext.Msg.alert('ì„±ê³µ', 'ë“±ë¡ ì™„ë£Œ');
        //         store.reload();
        //     },
        //     failure: function(response) {
        //         let msg = 'ë“±ë¡ ì‹¤íŒ¨';

        //             // ì„œë²„ì—ì„œ JSON í˜•íƒœë¡œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í–ˆë‹¤ë©´ íŒŒì‹±
        //             try {
        //                 const respObj = Ext.decode(response.responseText);
        //                 if (respObj && respObj.message) {
        //                     msg += `\n\nì‚¬ìœ : ${respObj.message}`;
        //                 }
        //             } catch (e) {
        //                 // íŒŒì‹± ì—ëŸ¬ê°€ ë‚˜ë©´ ë¬´ì‹œí•˜ê³  ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
        //             }

        //             Ext.Msg.alert('ì˜¤ë¥˜', msg);
        //     }
        // });


        const view = this.getView();
        const store = view.lookupReference('tsys1001_user_grid').getStore();
        const form = view.lookupReference('tsys1001_user_form');
        const values = form.getValues();
        values.userCetCd = dream.util.Common.LOGIN_USER_CET_CD;

        // ğŸ”¹ í™•ì¸ì°½ ì¶”ê°€
        Ext.Msg.confirm('í™•ì¸', 'ì‚¬ìš©ìë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(btn) {
            if (btn === 'yes') {
                Ext.Ajax.request({
                    url: dream.util.Common.BASE_URL + '/tsys/user/insert',
                    method: 'POST',
                    jsonData: values,
                    success: function() {
                        Ext.Msg.alert('ì„±ê³µ', 'ë“±ë¡ ì™„ë£Œ');
                        store.reload();
                    },
                    failure: function(response) {
                        let msg = 'ë“±ë¡ ì‹¤íŒ¨';

                        // ì„œë²„ì—ì„œ JSON í˜•íƒœë¡œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í–ˆë‹¤ë©´ íŒŒì‹±
                        try {
                            const respObj = Ext.decode(response.responseText);
                            if (respObj && respObj.message) {
                                msg += `\n\nì‚¬ìœ : ${respObj.message}`;
                            }
                        } catch (e) {
                            // íŒŒì‹± ì—ëŸ¬ ë°œìƒ ì‹œ ë¬´ì‹œí•˜ê³  ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
                        }

                        Ext.Msg.alert('ì˜¤ë¥˜', msg);
                    }
                });
            }
        });
    },

    onTsys1001_popup_custClick: function(button, e, eOpts) {
        const popup = Ext.create('dream.view.tpop.tpop1003');
        const me = this;

        popup.on('selectUser', function(win, record) {
            const form = me.lookupReference('tsys1001_user_form');
            form.down('[name=chulpanCd]').setValue(record.get('CUST_CD'));
            form.down('[name=chulpanNm]').setValue(record.get('CUST_NM'));
        });

        popup.show();
    },

    onTsys1001_popup_deptClick: function(button, e, eOpts) {
        const popup = Ext.create('dream.view.tpop.tpop1002');
        const me = this;

        popup.on('selectUser', function(win, record) {
            const form = me.lookupReference('tsys1001_user_form');
            form.down('[name=nDeptCd]').setValue(record.get('N_DEPT_CD'));
            form.down('[name=deptNm]').setValue(record.get('DEPT_NM'));
        });

        popup.show();
    },

    onTsys1001_user_updateClick: function(button, e, eOpts) {
        // const view = this.getView();
        // const store = view.lookupReference('tsys1001_user_grid').getStore();
        // const form = view.lookupReference('tsys1001_user_form');

        // if (!form.isValid()) {
        //     Ext.Msg.alert('ì˜¤ë¥˜', 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
        //     return;
        // }

        // const values = form.getValues();
        // values.userCetCd = dream.util.Common.LOGIN_USER_CET_CD; // í•„ìš”í•œ ê²½ìš° ì¶”ê°€

        // Ext.Ajax.request({
        //     url: dream.util.Common.BASE_URL + '/tsys/user/update',
        //     method: 'PUT',
        //     jsonData: values,
        //     success: function(response) {
        //         Ext.Msg.alert('ì„±ê³µ', 'ìˆ˜ì • ì™„ë£Œ');

        //         // í•„ìš” ì‹œ ê·¸ë¦¬ë“œë‚˜ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        //         const grid = Ext.ComponentQuery.query('grid[reference=tsys1001_user_grid]')[0];
        //         if (grid) {
        //             grid.getStore().reload();
        //         }
        //     },
        //     failure: function(response) {
        //         let msg = 'ìˆ˜ì • ì‹¤íŒ¨';
        //         try {
        //             const result = Ext.decode(response.responseText);
        //             if (result && result.message) {
        //                 msg += `\n\nì‚¬ìœ : ${result.message}`;
        //             }
        //         } catch (e) { }
        //         Ext.Msg.alert('ì˜¤ë¥˜', msg);
        //     }
        // });


        const view = this.getView();
        const store = view.lookupReference('tsys1001_user_grid').getStore();
        const form = view.lookupReference('tsys1001_user_form');

        if (!form.isValid()) {
            Ext.Msg.alert('ì˜¤ë¥˜', 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        const values = form.getValues();
        values.userCetCd = dream.util.Common.LOGIN_USER_CET_CD; // í•„ìš”í•œ ê²½ìš° ì¶”ê°€

        // ğŸ”¹ í™•ì¸ì°½ ì¶”ê°€
        Ext.Msg.confirm('í™•ì¸', 'ì„ íƒí•œ ì‚¬ìš©ìë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(btn) {
            if (btn === 'yes') {
                Ext.Ajax.request({
                    url: dream.util.Common.BASE_URL + '/tsys/user/update',
                    method: 'PUT',
                    jsonData: values,
                    success: function(response) {
                        Ext.Msg.alert('ì„±ê³µ', 'ìˆ˜ì • ì™„ë£Œ');

                        // í•„ìš” ì‹œ ê·¸ë¦¬ë“œë‚˜ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                        const grid = Ext.ComponentQuery.query('grid[reference=tsys1001_user_grid]')[0];
                        if (grid) {
                            grid.getStore().reload();
                        }
                    },
                    failure: function(response) {
                        let msg = 'ìˆ˜ì • ì‹¤íŒ¨';
                        try {
                            const result = Ext.decode(response.responseText);
                            if (result && result.message) {
                                msg += `\n\nì‚¬ìœ : ${result.message}`;
                            }
                        } catch (e) { }
                            Ext.Msg.alert('ì˜¤ë¥˜', msg);
                        }
                    });
                }
            });


    },

    onTsys1001_user_deleteClick: function(button, e, eOpts) {
        const view = this.getView();
        const grid = view.lookupReference('tsys1001_user_grid');
        const selection = grid.getSelectionModel().getSelection();
        const form = view.lookupReference('tsys1001_user_form');

        if (selection.length === 0) {
            Ext.Msg.alert('ì•Œë¦¼', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const record = selection[0]; // ë‹¨ì¼ ì„ íƒ ê°€ì •
        const userId = record.get('userId'); // PK ì»¬ëŸ¼ ì´ë¦„ì— ë”°ë¼ ì¡°ì • í•„ìš”

        console.log(userId);

        Ext.Msg.confirm('í™•ì¸', `'${userId}' ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, function(btn) {
        if (btn === 'yes') {
            Ext.Ajax.request({
                url: dream.util.Common.BASE_URL + '/tsys/delete/'+userId,
                method: 'DELETE',
                success: function(response) {
                    Ext.Msg.alert('ì„±ê³µ', 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    form.reset();
                    grid.getStore().reload();

                },
                failure: function(response) {
                    Ext.Msg.alert('ì˜¤ë¥˜', 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
    });
    },

    onTsys1001PanelBeforeRender: function(component, eOpts) {

        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/257',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('257', codeList);
            }
        });


        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/242',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('242', codeList);
            }
        });


        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/240',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('240', codeList);
            }
        });


        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/241',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('241', codeList);
            }
        });

        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/151',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('151', codeList);
            }
        });

        Ext.Ajax.request({
            url: dream.util.Common.BASE_URL + '/api/code/373',
            method: 'GET',
            success: function(response) {
                const codeList = Ext.decode(response.responseText);
                dream.util.Common.setCodeData('373', codeList);
            }
        });


    }

});
